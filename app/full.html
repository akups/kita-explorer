<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Berlins Kindertagesstätten</title>
  <meta name="description" content="Berlins Kindertagesstätten">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Contrail+One|Open+Sans:300,700" rel="stylesheet">
  <style type="text/css">
    
    html, body{ 
      margin:0; 
      padding:0; 
      border:0; 
      width:100%; 
      height:100%; 
      font-family: 'Open Sans', sans-serif;
    }

    #vis{
      margin: 0 auto;
    }

    h1{
      font-family:Clan,sans-serif;
      margin:-150px 0 150px 0;
      display: block;
      text-align: center;
      text-shadow: 0px 0px 5px rgba(255, 255, 255, 1);
      font-family: 'Contrail One', sans-serif;
      font-size:36px;
    }

    #intro{
      padding-top:100px;
    }

    #children .col-2, #intro .col-2{
      width:55%;
      float:left;
    }

    #intro .col-1, #children .col-1{
      width:45%;
      float:left;
      text-align: right;
    }

    #children p, #intro p{
      padding:0 30px;
      max-width:400px;
      font-size:18px;
      text-align: left;
    }

    #intro img{
      max-width: 100%;
      height:auto;
    }

    @media (max-width: 768px) {
      #intro{ padding-top:30px;}
      #intro .col-1{ display: none; }
      #intro .col-2{ width:100%; }
      #intro p{ margin:0 auto; }
    }

    #trends{
      min-width:768px;
      width:100%;
      margin:0 auto;
      clear:both;
      padding-top:100px;
    }

    .col{
      float:left;
      min-width:256px;
      width:33%;
      text-align: right;
    }

    .col svg{
      margin-right:5px;
    }

    .col h2{
      text-align: left;
      padding:0;
      margin:10px 0 10px 57px;
    }

    .col .top{
      display: block;
      height:5px;
      min-width: 256px;
      margin:0;
      padding:0;
      background-image:url('images/shadow_top@2x.png');
      background-position: bottom right;
      background-size: 256px 5px;
      background-repeat: no-repeat;
    }

    .col .bottom{
      display: block;
      height:5px;
      min-width: 256px;
      margin:0;
      padding:0;
      background-image:url('images/shadow_bottom@2x.png');
      background-position: top right;
      background-size: 256px 5px;
      background-repeat: no-repeat;
    }

    .col .mid{
      margin:0;
      padding:5px 10px 5px;
      background-image:url('images/shadow_bg@2x.png');
      background-position: right;
      background-size: 256px 1px;
      background-repeat: repeat-y;
    }

    .col.no-bg .top, .col.no-bg .bottom, .col.no-bg .mid{
      background-image:none;
    }

    #trend-2{
      display: none;
    }

    .col .mid .inner{
      overflow-x:hidden;
      max-height: 800px;
      overflow-y: auto;
    }

    #trends text{
      font-size:12px;
      font-weight:700;
    }

    #trends path{
      stroke-width:1px;
      fill:transparent;
      stroke:#000;
    }

    #children{
      clear:both;
      padding-top:100px;
    }

    #trends .bg-overlay{
      cursor: pointer;
    }

    #trends .bg-normal{
      fill:rgba(0,0,0,0.1);
    }

    #trends .bg-predict{
      fill:rgba(33, 167, 202, 0.29);
    }

    #trends .active .bg-normal{
      fill:rgba(0,0,0,0.3);
    }

    #trends .active .bg-predict{
      fill:rgba(33, 167, 202, 0.6); 
    }

    #icons{
      clear:both;
      width:920px;
      margin:0 auto;
      padding-top:100px;
    }

    #icons text{
      font-size:11px;
    }

    #icons h2{
      text-align: center;
    }

    #icon_controlls{
      text-align: center;
    }

    #icon_controlls img{
      height:20px;
      width:9.5px;
    }

    .db{
      font-weight:700;
      font-size:14px;
      background-color:#64B9E6;
      border-radius: 5px;
      padding:5px 10px;
      color:#fff;
    }

    .db:hover, .db.active{
      background-color:#1E3890;
      cursor: pointer;
    }

    .db.db-right{
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .db.db-left{
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      margin-right:1px;
    }

    #icon_controlls .def{
      font-size:14px;
    }

    .tooltip line{
      stroke-dasharray:2, 2;
      stroke:#000;
      stroke-width:1px;
    }

    #trend-info p{
      text-align: left;
      font-size:14px;
      padding-left:13px;
    }

    #trend-info img{
      width:24px;
      height: auto;
      margin-right:20px;
      float:left;
      margin-top:9px;
      margin-bottom:20px;
    }

    #trend-info .color-block{
      margin-bottom: 20px;
    }

    .color-block{
      float:left;
      width:15px;
      height:15px;
      display: block;
      margin-right:23px;
      margin-top:11px;
      margin-left:5px;
    }

    .color-block.blue{
      background-color:rgba(33, 167, 202, 0.6);
    }

    #children .col-1 *{
      float:right;
    }

    #children .col-1{
      padding-top:70px;
    }

    #children img{
      width:80px;
      height:auto;
      margin-right:20px;
    }

    #children .big{
      font-weight:700;
      font-size:40px;
      text-align: center;
      margin-top:7px;
    }

    #children .small{
      font-size:12px;
      font-weight:300;
    }

    #filter{
      clear:both;
      margin:0 50px;
      padding-top:100px;
    }

    #filter .col-1{
      width:33%;
      float:left;
      display: block;
    }

    #filter .col-2{
      width:66%;
      float:left;
    }

    #filter .col-2 svg{
      width:100%;
      height:auto;
    }

    #filter .map path{
      fill:transparent;
      stroke:#CCC;
      stroke-linejoin: round;
      stroke-linecap: round;
    }

    #filter .map circle{
      stroke:transparent;
      fill:rgba(0,0,0,0.5);
    }

    #filter .map rect{
      stroke:transparent;
      fill:transparent;
      pointer-events: all;
    }

    #filter .list li, #filter .list ul{
      list-style: none;
      margin:0;
      padding:0;
      width:100%;
      border: none;
    }

    #filter .list li{
      border-bottom:1px solid rgba(0,0,0,0.3);
      padding:10px 0;
    }

    #filter .list li:nth-child(even){background-color:rgba(0,0,0,0.1); }
    #filter .list li:nth-child(odd){ background-color:rgba(0,0,0,0.05); }

    #filter .list span{
      display: block;
      padding: 0 10px;
    }

    #filter .list .type{
      font-size: 10px;
    }

    #filter .list .name{
      font-size: 16px; 
      font-weight:700;
    }

    #filter .list .address{
      font-size: 12px;
    }

    #filter .list{
      height: 700px;
      overflow-y:auto;
      overflow-x:hidden;
      display: none;
    }

    #filter .col-1{
      overflow-y:auto;
    }

    #filter .col-1 svg text{
      font-size:12px;
    }

    .filter-title{
      font-size:18px;
      font-weight: bold;
      text-transform: capitalize;
      padding-bottom:10px;
      display: block;
      padding-top:20px;
    }

    .filter-container{
      margin:0 20px;
    }

    .filter-container div{
      overflow: hidden;
      width:360px;
    }

  </style>
</head>
<body>
  <div id="header"></div>
  <h1>Kindertagesstätten in Berlin</h1>
  <div id="intro">
    <div class="col-1">
      <img src="images/swingset@2x.png" width="278" height="235" />
    </div>
    <div class="col-2">
       <p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate.</p>
    </div>
  </div>
  <div id="icons">
      <h2>Kinder in den Bezirken</h2>
      <div id="icon_controlls">
        <span class="db db-left active">Anzahl Kinder im Bezirk</span><span class="db db-right">Anzahl Kinder pro 60 Einwohner*innen</span><br /><br />
        <img src="./images/Icon-explain.png" alt="Icon für Kind" />&nbsp;&nbsp;<span class="def"></span>
      </div>
  </div>
  <div id="trends">
    <div class="col" id="trend-1">
      <div class="top"></div>
      <div class="mid">
        <h2>Kita-Kinder pro Bezirk</h2>
        <div class="inner"></div>
      </div>
      <div class="bottom"></div>
    </div>
    <div class="col" id="trend-2">
      <div class="top"></div>
      <div class="mid">
        <h2></h2>
        <div class="inner"></div>
      </div>
      <div class="bottom"></div>
    </div>
    <div class="col no-bg" id="trend-3">
      <div class="top"></div>
      <div class="mid">
        <h2></h2>
        <div class="inner"></div>
        <div id="trend-info">
          <p class="interaction-info">
            <img src="./images/touch@2x.png" /> Fahren Sie mit der Maus über die Bezirke um mehr über die Entwicklung der jungen Einwohner*innen zu erfahren. Klicken Sie auf einen <span class="trend-type">Bezirk</span> um mehr Details zu sehen.
          </p>
          <p class="prediction-info">
            <span class="color-block blue"></span> Der blau hervorgehobene Bereich ist eine statistisch berechnete Prognose für das Jahr 2017.
          </p>
        </div>
      </div>
      <div class="bottom"></div>
    </div>
  </div>
  <div id="children">
    <div class="col-1">
      <p class="big">179.678 Kinder<br /><span class="small">im Alter zwischen 1 und 6 Jahren</span></p>
      <img src="./images/Icon-kids@2x.png" />
    </div>
    <div class="col-2">
       <p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate.</p>
    </div>
  </div>
  <div id="filter">
    <div class="col-1"></div>
    <div class="col-2">
      <div class="ui">
        <span class="db db-left active">Karte</span><span class="db db-right">Liste</span><br /><br />
      </div>
      <div class="toggle">
        <div class="map"></div>
        <div class="list"></div>
      </div>
    </div>
  </div>
  <script src="js/d3.v4.min.js"></script>
  <script src="js/topojson.v1.min.js"></script>
  <script src="js/turf.min.js"></script>
  <script type="text/javascript">
  
    function debouncer( func , timeout ) {
      var timeoutID , timeout = timeout || 200;
      return function () {
        var scope = this , args = arguments;
        clearTimeout( timeoutID );
        timeoutID = setTimeout( function () {
          func.apply( scope , Array.prototype.slice.call( args ) );
        } , timeout );
      };
    }

    var header = (function (container) {

      container.select('svg').remove();

      var module = {},
        svg = container.append('svg'),
        points = container.select('svg').append('g'),
        projection = d3.geoMercator(),
        kitas=null,
        x_extent=null,
        y_extent=null,
        radius=null;

      module.update = function(){
        var w = window.innerWidth - 20, 
          h = (window.innerHeight < 600)?(window.innerHeight*0.5):300;

        svg.attr('width',w)
          .attr('height', h);

        points.selectAll('circle').remove();
        points.selectAll('circle').data(kitas).enter().append('circle')
          .attr('r', function(d){ return radius(+d.all); })
          .attr('cx', function(d){ return (d.x-x_extent[0])/(x_extent[1]-x_extent[0])*w; })
          .attr('cy', function(d){ return (d.y-y_extent[0])/(y_extent[1]-y_extent[0])*h - 5; })
          .style('fill', function(){
            return "hsl("+Math.round(Math.random()*360)+", 70%, 70%)";
          });
      };

      //TODO: Just load the CSV once and pass to the modules
      d3.csv('./data/kitas.csv', function(err,data){
        kitas = data;

        kitas.forEach(function(k){
          var p = projection([k.lat, k.lon]);
          k.all = +k.all;
          if(isNaN(k.all)){
            k.all = 0;  
          }
          k['x'] = p[0];
          k['y'] = p[1];
        });

        x_extent = d3.extent(kitas, function(k){return k.x;});
        y_extent = d3.extent(kitas, function(k){return k.y;});

        radius = d3.scaleLinear().range([0,10]).domain([0,d3.max(kitas, function(k){return +k.all;})]);

        module.update();
      });

      return module;
    });

    var trend = (function (container, _level, _dict, _label){

      container.selectAll('*').remove();

      if(_level>1){
        d3.select(container.node().parentNode).selectAll('h2').text(_label);
      }

      var module = {},
          level = _level,
          padding = 60,
          el_margin = 10,
          width = container.node().getBoundingClientRect().width-5,
          el_height = 50, els = [],
          dict = _dict, csv = null, csv_keys = {},
          svg = container.append('svg').attr('width',width),
          years = [2001,2016,2017];

      module.draw = function(){
        svg.selectAll('*').remove();

        var root_count = 0;
        for(var key in dict){
          root_count++;
        }

        svg.attr('height', root_count*(el_height+el_margin)+50+3);

        var x = d3.scaleLinear().domain([years[0],years[2]]).range([0,width-padding]);
        var max = 0;
        for(var i in dict){
          max = d3.max([max, d3.max(dict[i].sum)]);
        }
        var y = d3.scaleLinear().range([el_height,0]).domain([0,max]);
        var xAxisBottom = d3.axisBottom().scale(x).tickFormat(function(d){ return "'"+(((d-2000)<10)?'0':'')+(d-2000); }).ticks(10);
        var xAxisTop = d3.axisTop().scale(x).tickFormat(function(d){ return "'"+(((d-2000)<10)?'0':'')+(d-2000); }).ticks(10);
        var yAxis = d3.axisLeft().scale(y).tickFormat(d3.format("")).ticks(3);
        var line = d3.line()
          .x(function(d,i){return x(years[0]+i);})
          .y(function(d){ return y(d);});

        var ic = 0;
        for(var i in dict){
          var g = svg.append('g')
            .attr('class','visgroup')
            .attr('transform','translate('+(padding-2)+','+ (ic*(el_height+el_margin)+35)+')');

          g.append('rect')
            .attr('width',x(years[1]))
            .attr('height', el_height)
            .attr('class', 'bg-normal');

          g.append('rect')
            .attr('width',(x(years[0]+1)))
            .attr('transform','translate('+x(years[1])+',0)')
            .attr('height', el_height)
            .attr('class', 'bg-predict');            

          g.selectAll('line').data(new Array(5)).enter().append('line')
            .attr('x1', 0)
            .attr('x2', x(years[2]))
            .attr('class', 'ylines')
            .style('stroke', 'rgba(0,0,0,0.1)')
            .attr('y1', function(d,i){ return i*10; })
            .attr('y2', function(d,i){ return i*10; });

          g.append('text')
            .attr('dx',5)
            .attr('dy',(y(dict[i].sum[0])>35)?15:45)
            .attr('class', 'label')
            .text(dict[i].n);

          g.append('path')
            .attr('class', 'trend')
            .attr('d', line(dict[i].sum));

          var tooltip = g.append('g')
            .attr('class', 'tooltip')
            .style('display', 'none');

          tooltip.append('line')
            .attr('x1', 0)
            .attr('x2', 0)
            .attr('y1', 0)
            .attr('y2', el_height);

          tooltip.append('rect')
            .attr('x', -18)
            .attr('y', el_height/2-9)
            .attr('width', 36)
            .attr('height', 10)
            .style('fill','#000')
            .style('stroke-linejoin','round')
            .style('stroke-width',8)
            .style('stroke','#000');

          tooltip.append('text')
            .datum(dict[i].sum)
            .attr('class','label')
            .attr('text-anchor','middle')
            .attr('dy', el_height/2)
            .style('fill','#fff');

          g.append('g')
            .attr('class', 'axis')
            .style('display', (ic!=0)?'none':'block')
            .attr('transform','translate('+(-9)+','+0+')')
            .call(yAxis);

          g.append('rect')
            .datum(dict[i])
            .attr('width',(x(years[2])))
            .attr('height', el_height)
            .attr('class', 'bg-overlay')
            .style('fill','transparent')
            .on('mouseenter', function(d){
              svg.selectAll('.axis').style('display','none');
              svg.selectAll('path.trend').style('stroke-width',1);
              var group = d3.select(this.parentNode);
                group.select('.axis').style('display','block');
                group.select('path.trend').style('stroke-width','3');
            })
            .on('mousemove', function(){
              var year = Math.round(x.invert(d3.mouse(this)[0]));

              var tooltip = svg.selectAll('.tooltip')
                .style('display','block')
                .attr('transform','translate('+ x(year) +',0)');

              tooltip.select('.label')
                .attr('dx', ((year == years[2])?-19:((year == years[0])?19:0)))
                .text(function(d){
                  return Math.round(d[year-years[0]]);
                });

              tooltip.select('rect')
                .attr('x', ((year == years[2])?-38:((year == years[0])?2:-18)));

            })
            .on('mouseleave', function(d){
              svg.selectAll('.tooltip').style('display','none');
              svg.selectAll('path.trend').style('stroke-width',1);
            })
            .on('click', function(d){
              if(level<3){
                if(level == 1){
                  d3.select('#trend-3 h2').text('');
                  d3.select('#trend-3 svg').remove();
                  d3.select("#trend-3"+(level+1)+' .inner').style('display','none');
                }
                svg.selectAll('.visgroup').classed('active',false);
                d3.select(this.parentNode).classed('active',true);
                d3.select("#trend-"+(level+1)).style('display','block');
                vis['trend_'+(level+1)] = trend(d3.select("#trend-"+(level+1)+" .inner"), (level+1), d.c, d.n);
              }
            });

          ic++;
        }

        svg.append('g')
          .attr('transform','translate('+(padding-2)+','+23+')')
          .call(xAxisTop);

        svg.append('g')
          .attr('transform','translate('+(padding-2)+','+(ic*(el_height+el_margin)+35)+')')
          .call(xAxisBottom);
      }

      function processDict(dict){
        for(var key in dict){
          dict[key]['sum'] = [];

          for(var i = years[0]; i<=years[2]; i++){
            dict[key].sum.push(+csv[csv_keys[dict[key].fid]][i]);
          }

          processDict(dict[key].c);
        }
      }

      module.update = function(){
        width = container.node().getBoundingClientRect().width-5;
        svg.attr('width',width);
        module.draw();
      };

      if(!dict){
        d3.json('./data/lor_dict.json', function(err, data){
          if(err){console.log(err);}

          dict = data;

          d3.csv('./data/EWR.min.csv', function(err, data){
            if(err){console.log(err);}

            csv = data;
            csv.forEach(function(c,ci){
              csv_keys[c.fid] = ci;
              csv_keys[c.id] = ci;
            });

            processDict(dict);

            module.draw();

          });
        });
      }else{
        module.draw();
      }

      return module;
    });

    var icons = (function(container){
      var module = {},
        svg = container.append('svg').attr('width', 920).attr('height', 514).append('g').attr('transform', 'translate(10,10)'),
        dict = null,
        csv = null, csv_keys = {},
        all_max = 0,
        max = 0,
        icon_w = 11,
        cols = 10,
        rows = 6,
        icon_h = 20,
        spacing = 3,
        margin = 15,
        state = 0,
        icons = rows*cols,
        width = cols*icon_w + spacing*(cols-1),
        height = rows*icon_h + spacing*(rows-1),
        setup = {
          0:{x:2,y:1},
          56:{x:3,y:1},
          96:{x:3,y:0},
          160:{x:1,y:1},
          241:{x:0,y:1},
          294:{x:1,y:2},
          348:{x:2,y:2},
          397:{x:3,y:2},
          452:{x:4,y:2},
          512:{x:5,y:1},
          559:{x:4,y:1},
          610:{x:2,y:0}
        };

      d3.selectAll('#icon_controlls .db').on('click', function(){
        d3.selectAll('#icon_controlls .db').classed('active',false);
        var db = d3.select(this).classed('active',true);
        if(db.attr('class').indexOf('left')>=0){
          module.set(0);
        }else{
          module.set(1);
        }
      });

      module.draw = function(){
        for(var key in dict){
          var g = svg.append('g')
            .attr('transform', 'translate('+ setup[dict[key].id].x*(width+margin) +','+ setup[dict[key].id].y*(height+20+margin) +')');

          var gis = [];

          /*g.append('rect')
            .attr('width',width)
            .attr('height',height)
            .attr('x', 0)
            .attr('y', 20)
            .style('stroke', '#000')
            .style('fill', 'transparent');*/

          g.append('text')
            .attr('dy',10)
            .text(dict[key].n);

          var gi = g.append('g').attr('transform','translate(0,20)');

          for(i = 0; i<icons; i++){
            gis.push(gi.append('image')
              .attr('xlink:href', './images/Icon-' + ((i % 2 == 0)?'male':'female') + '.png')
              .attr('width',11)
              .attr('height',20)
              .attr('x', (i - Math.floor(i/cols)*cols)*(icon_w+spacing))
              .attr('y', Math.floor(i/cols)*(icon_h+spacing))
              .style('opacity', 0.2));
          }

          dict[key]['icons'] = gis;
        }

        module.animate();
      };

      module.set = function(_state){
        state = _state;
        module.animate();
      };

      module.animate = function(){
        for(var key in dict){
          if(state == 0){
            d3.select('#icon_controlls .def').text('entspricht ca. '+Math.round(max/icons)+ ' Kindern im Alter von 1 bis 6 Jahren');
            var num = dict[key]['2016']/max*icons;
          }else{
            d3.select('#icon_controlls .def').text('entspricht einem Kind im Alter von 1 bis 6 Jahren pro 60 Einwohner');
            var num = dict[key].rel * icons;  
          }

          for(var i = 0; i<num; i++){
            dict[key].icons[i].transition().duration(500).style('opacity',1);
          }

          if(num != Math.round(num)){
            dict[key].icons[i].transition().duration(500).style('opacity',((num-Math.floor(num))*0.8 + 0.2));
            i++;
          }

          for(i = i; i<icons; i++){
            dict[key].icons[i].transition().duration(500).style('opacity',0.2);
          }
        }
      };

      function addIcon(g, i, o){
        return  
      }

      module.update = function(){};

      d3.json('./data/lor_dict.json', function(err, data){
        if(err){console.log(err);}

        dict = data;

        d3.csv('./data/EWR.min.csv', function(err, data){
          if(err){console.log(err);}

          csv = data;
          csv.forEach(function(c,ci){
            csv_keys[c.fid] = ci;
            csv_keys[c.id] = ci;
          });

          for(var key in dict){
            dict[key]['2016'] = +csv[csv_keys[dict[key].fid]]['2016'];
            dict[key]['all'] = +csv[csv_keys[dict[key].fid]].all_2016;
            dict[key]['rel'] = dict[key]['2016'] / dict[key].all;
            if(dict[key]['2016'] > max){
              max = dict[key]['2016'];
            }
            if(dict[key].rel > all_max){
              all_max = dict[key].rel;
            }
          }

          module.draw();

        });
      });

      return module;
    });

    var filter = (function(container){

      var module = {},
        filterlist = container.select('.col-1'),
        ui = container.select('.col-2 .ui'),
        list = container.select('.col-2 .list'),
        lor, kitas, kitas_dict, kitas_keys = {},
        width = 850,
        height = 700,
        circles,
        radius = d3.scaleLinear().domain([0,200]).range([0.1,1.2]),
        svg = container.select('.col-2 .map').append('svg')
          .attr('width',width)
          .attr('height', height)
          .attr("viewBox", "0 0 "+width+" "+height)
          .attr("preserveAspectRatio", "xMinYMin meet")
          .attr("class", "svg-content-responsive"),
        map = svg.append('g'),
        projection = d3.geoMercator()
          .center([13.43, 52.51])
          .scale(70000)
          .translate([width / 2, height / 2]);

      d3.queue()
        .defer(d3.json, './data/lor_topojson/Bezirk.topojson')
        .defer(d3.json, './data/kitas_dict.json')
        .defer(d3.csv, './data/kitas.csv')
        .await(function(err, _lor, _dict, _kitas){
          if(err){console.log(err);}
          kitas = _kitas;

          kitas.forEach(function(k){
            var lat = +k.alat,
              lon = +k.alon;

            if(k.e == 2){
              lat = +k.lat;
              lon = +k.lon;
            }

            var p = projection([lon, lat]);
            k['px'] = p[0];
            k['py'] = p[1];
            k.all = +k.all;
            if(isNaN(k.all)){k.all = 0;}

            var pre = ['AWO Kita', 'AWO ', 'AWO-Kita', 'BOOT-KITA', 'Evangelische Kita ', 'EKG - ', 'EKT - ', 'FRÖBEL Kindergarten ', 'Humanistische Kita ', 'IB-Kita, ', 'Kindergarten ', 'Kita - ', 'Kita ', 'Kindertagesstätte ', 'Kita der Ev. Kirchengem. ', 'Kita der Kath. Kirchengem. ', 'Kinderladen ', 'Kita/', 'Ev. Kita ', 'Ev.Kita ', '- '];
            pre.forEach(function(p){
              if(k.name.substr(0, p.length) == p){
                k.name = k.name.substr(p.length, k.name.length);
              }
            });

            k.name = k.name.trim();
            k.name = k.name.substr(0,1).toUpperCase() + k.name.substr(1,k.name.length);
          });

          kitas.sort(function(a, b){
            if(a.name < b.name){
              return -1;
            }else if(a.name > b.name){
              return 1;
            }else{
              return 0;
            }
          });

          kitas_dict = _dict;
          lor = _lor;

          module.buildMap();
          module.buildList();
          module.buildFilter();
          module.buildUI();
        });

      module.buildMap = function(){
        var features = topojson.feature(lor, lor.objects.Bezirk).features;
        var path = d3.geoPath().projection(projection);
        
        map.selectAll('path').data(features).enter().append("path")
          .attr("d", path);

        circles = map.selectAll('circle').data(kitas).enter().append('circle')
          .attr('title', function(d){
            return d.id;
          })
          .attr('cx', function(d){
            return d.px;
          })
          .attr('cy', function(d){
            return d.py;
          })
          .attr('r', function(d){
            return 1+radius(d.all)/0.5;
          });

        const zoom = d3.zoom()
          .scaleExtent([1, 40])
          .on('zoom', function(){
            map.selectAll('path').style('stroke-width', 1/d3.event.transform.k);
            circles.attr('r', function(d){ return 1+radius(d.all)/(d3.event.transform.k/2); });
            map.attr('transform', d3.event.transform);
          });

        svg.call(zoom);
      };

      module.buildList = function(){
        var li = list.append('ul').selectAll('li').data(kitas).enter().append('li')

        li.append('span').attr('class', 'type')
          .text(function(d){return kitas_dict.type[d.type]+' der '+kitas_dict.parent[d.parent];});

        li.append('span').attr('class', 'name')
          .text(function(d){return d.name;});

        li.append('span').attr('class', 'address')
          .text(function(d){return d.address+', '+d.plz+' '+d.district;});
      };

      module.buildFilter = function(){

        var filter = ['type','languages','topics','educational', 'parent'], //parent, , 'parentType'
          filters = {};

        filter.forEach(function(f){
          filters[f] = [];
          kitas_dict[f].forEach(function(ff, ffi){
            filters[f].push({count:0, id:ffi, name:ff});
          });
        });

        kitas.forEach(function(k){
          filter.forEach(function(f){
            if(!isNaN(parseInt(k[f]))){
              filters[f][parseInt(k[f])].count++;
            }
          });
        });

        var lineHeight = 24;

        filter.forEach(function(f){
          var height = lineHeight*filters[f].length;

          var box = filterlist.append('div').attr('class','filter-container');
          box.append('span')
            .attr('class', 'filter-title')
            .text(f);

          var boxHeight = ((height>10*lineHeight)?10*lineHeight:height);
          var svg = box.append('div')
            .style('height', (boxHeight)+'px')
            .append('svg')
              .attr('width', 360)
              .attr('height', height);

          var w = d3.scaleLinear().domain([0,d3.max(filters[f], function(d){return d.count;})]).range([0,360]);

          filters[f].sort(function(a,b){
            return b.count-a.count;
          });

          var groups = svg.selectAll('g').data(filters[f]).enter().append('g')
            .attr('transform', function(d,i){
              return 'translate(0,'+ i*lineHeight +')';
            });

          groups.append('rect')
            .attr('height', lineHeight-1)
            .style('fill', 'rgba(0,0,0,0.3)')
            .attr('width', function(d,i){return w(d.count);});

          groups.append('text')
            .text(function(d){ return d.name+' ('+d.count+')'; })
            .attr('dy', 15)
            .attr('dx', 5);
          
        });
      };

      module.buildUI = function(){

      };

      module.update = function(){

      };

      return module;

    });

    var vis = {
      header:header(d3.select("#header")),
      trend_1:trend(d3.select("#trend-1 .inner"),1,false,false),
      icons:icons(d3.select('#icons')),
      filter:filter(d3.select('#filter'))
    };

    d3.select(window).on('resize', debouncer(function(){
      for(var key in vis){
        vis[key].update();
      }
    }));

  </script>
</body>
</html>
