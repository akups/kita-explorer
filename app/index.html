<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Berlins Kindertagesstätten</title>
  <meta name="description" content="Berlins Kindertagesstätten">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Contrail+One|Open+Sans:300,300i,700" rel="stylesheet">
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet' />
  <link href="./css/logo.css" rel="stylesheet">
  <link href='./css/style.css' rel='stylesheet' />
</head>
<body>
  <div id="header">
    <div id="logo"><img src="images/logo-tsb.svg" alt="Technologiestiftung Berlin" /></div>
    <h1>KITA-Suche</h1>
  </div>
  <div class="loading">
    <div class="outer"><div class="middle"><div class="inner">
      <div id="loader">
        <img class="i1" src="images/ani-1@2x.png" />
        <img class="i2" src="images/ani-2@2x.png" />
        <img class="i3" src="images/ani-3@2x.png" />
        <img class="i4" src="images/ani-4@2x.png" />
      </div>
    </div></div></div>
  </div>
  <!--<div id="welcome">
    <div class="outer"><div class="middle"><div class="inner">
      <h2>Wilkommen</h2>
      <p>Bitte geben Sie Ihre Straße und Hausnummer ein:</p>
      <div id="form">
        <input type="text" id="address" name="address" placeholder="Adresse..." autocomplete="off" />
        <select id="number" name="number"></select>
        <div id="autosuggest"><span>Bitte Straße auswählen:</span><ul></ul></div>
        <input type="button" id="submit" value="Kitas suchen" />
      </div>
    </div>
  </div>-->
  <div id="map"></div>
  <div id="sidebar">
    <div id="sidebar-content">
      <div id="details" class="sidebar-content">
        <div class="inner">
          <div class="loading">
            <div class="outer"><div class="middle"><div class="inner">
              <div id="loader">
                <img class="i1" src="images/ani-1@2x.png" />
                <img class="i2" src="images/ani-2@2x.png" />
                <img class="i3" src="images/ani-3@2x.png" />
                <img class="i4" src="images/ani-4@2x.png" />
              </div>
            </div></div></div>
          </div>
          <div id="detail-content">
            <span id="detail-type"></span>
            <a id="detail-close"></a>
            <h2 id="detail-name"></h2>
            <span id="detail-parent"></span>
            <span id="detail-parentType"></span>

            <p id="detail-location">
              <span id="detail-address"></span><br />
              <span id="detail-postcode"></span> Berlin (<span id="detail-district"></span>)
            </p>

            <p id="detail-contact">
                <span id="detail-phone"></span><br />
                <a id="detail-email" href=""></a><br />
            </p>

            <h3 id="detail-educational-head">Pädagogische Schwerpunkte</h3>
            <ul id="detail-educational">
            </ul>

            <h3 id="detail-topics-head">Thematische Schwerpunkte</h3>
            <ul id="detail-topics">
            </ul>

            <h3 id="detail-languages-head">Mehrsprachigkeit</h3>
            <ul id="detail-languages">
            </ul>

            <h3 class="detail-open">Öffnungszeiten</h3>
            <table class="detail-open" cellpadding="0" cellspacing="0" border="0">
              <thead>
                <tr>
                  <th>Mo.</th>
                  <th>Di.</th>
                  <th>Mi.</th>
                  <th>Do.</th>
                  <th>Fr.</th>
                  <th>Sa.</th>
                  <th>So.</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="detail-open-0"></td>
                  <td id="detail-open-1"></td>
                  <td id="detail-open-2"></td>
                  <td id="detail-open-3"></td>
                  <td id="detail-open-4"></td>
                  <td id="detail-open-5"></td>
                  <td id="detail-open-6"></td>
                </tr>
              </tbody>
            </table>

            <h3 id="detail-structure-head">Plätze</h3>
            <table cellpadding="0" cellspacing="0" border="0">
              <tbody>
                <tr id="detail-structure-overall-row">
                  <th>Plätze insgesamt:</th>
                  <td id="detail-structure-overall"></td>
                </tr>
                <tr id="detail-structure-under-row">
                  <th>unter 3 Jahren:</th>
                  <td id="detail-structure-under"></td>
                </tr>
                <tr id="detail-structure-over-row">
                  <th>über 3 Jahren:</th>
                  <td id="detail-structure-over"></td>
                </tr>
                <tr id="detail-structure-min-row">
                  <th>frühestes Aufnahmealter in Monaten:</th>
                  <td id="detail-structure-min"></td>
                </tr>
                <tr id="detail-structure-mix-row">
                  <th>Altersmischung:</th>
                  <td id="detail-structure-mix"></td>
                </tr>
              </tbody>
            </table>
            
            <div id="detail-meta">
              ID: <span id="detail-id"></span> NUM:<span id="detail-num"></span><br />
              <a id="detail-link" href="">Auf Berlin.de einsehen &raquo;</a><br />
              <a id="detail-mapLink" href="">Auf Berlin.de-Stadtplan anschauen &raquo;</a>
            </div>
          </div>
        </div>
      </div>
      <div id="list" class="sidebar-content">
        <div class="inner">
          <div id="search">
            <input type="text" placeholder="Suche..." />
          </div>
          <ul>
          </ul>
        </div>
      </div>
      <div id="postcode" class="sidebar-content">
        <div class="inner">
          <div id="postcode-container">
            <strong>Postleitzahlsuche:</strong>
            <input type="text" placeholder="Postleitzahl" id="postcode-input" />
            <p id="postcode-error"></p>
            <p>
              <img src="images/touch@2x.png" alt="Finden Sie die Kitas in einem bestimmten Postleitzahlgebiet." />Finden Sie die Kitas in einem bestimmten Postleitzahlgebiet.
            </p>
          </div>
        </div>
      </div>
      <div id="filter" class="sidebar-content">
        <div class="inner">
          <div id="filter-container">
            <strong>Filter:</strong>
            <a id="reset"><img src="images/icon-reset@2x.png" width="14" alt="Filter zurücksetzen" />Filter zurücksetzen</a>
          </div>
          <p>
            <img src="images/touch@2x.png" alt="Sie können einen oder mehrere Filter auswählen um die entsprechenden Kitas hervorzuheben." />Jeder Oberpunkt enthält mehrere Filter. Sie können einen oder mehrere Filter auswählen um die entsprechenden Kitas hervorzuheben.
          </p>
        </div>
      </div>
    </div>
    <div id="sidemenu">
      <ul class="top">
        <li data-item="filter">
          <img src="images/menu-filter-white@2x.png" alt="Filter" width="40" class="white" />
          <img src="images/menu-filter-black@2x.png" alt="Filter" width="40" class="black" />
          <span>Filter</span>
        </li>
        <li data-item="postcode">
          <img src="images/menu-postcode-white@2x.png" alt="PLZ" width="40" class="white" />
          <img src="images/menu-postcode-black@2x.png" alt="PLZ" width="40" class="black" />
          <span>PLZ</span>
        </li>
        <li data-item="locate">
          <img src="images/menu-dist-white@2x.png" alt="Umkreissuche" width="40" class="white" />
          <img src="images/menu-dist-black@2x.png" alt="Umkreissuche" width="40" class="black" />
          <span>Umkreis</span>
        </li>
        <li data-item="list">
          <img src="images/menu-list-white@2x.png" alt="Liste" width="40" class="white" />
          <img src="images/menu-list-black@2x.png" alt="Liste" width="40" class="black" />
          <span>Liste</span>
        </li>
      </ul>
      <ul class="bottom">
        <li data-item="info">
          <img src="images/menu-info-white@2x.png" alt="Info" width="40" class="white" />
          <img src="images/menu-info-black@2x.png" alt="Info" width="40" class="black" />
          <span>Info</span>
        </li>
        <li data-item="legal">
          <img src="images/menu-legal-white@2x.png" alt="Legal" width="40" class="white" />
          <img src="images/menu-legal-black@2x.png" alt="Legal" width="40" class="black" />
          <span>Legal</span>
        </li>
      </ul>
    </div>
  </div>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
  <script type="text/javascript">

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'style.json',
      center: [13.4244,52.5047],
      zoom: 10
    });

    map.fitBounds([[13.0790332437,52.3283651024],[13.7700526861,52.6876624308]],
      {
        offset: [0, 50],
        speed:999
      });

    var el = document.createElement('div');
      el.className = 'marker';

    var marker = false;


    var kitas, kitas_dict, kitas_keys = {}, selection = {},
      labels = {
        type: 'Art der Einrichtung',
        languages :'Mehrsprachigkeit',
        topics: 'Thematische Schwerpunkte',
        educational:'Pädagogische Schwerpunkte',
        parentType:'Träger'
      },
      detailShow = false,
      geojson = {},
      filterElements = {},
      defaultLayer = null,
      activeLayer = null,
      filterKeys = {},
      postcodes = null, postcodeKeys = [],
      scales = {},
      filter = ['type','languages','topics','educational','parentType'], //parent;
      filters = {};

    d3.queue()
      .defer(d3.csv, "data/kitas.csv")
      .defer(d3.json, "data/kitas_dict.json")
      .defer(d3.csv, "data/plz.csv")
      .await(function(error, file1, file2, file3) {
        if (error) { console.error(error); 
        } else {
          kitas = file1;
          kitas_dict = file2;
          postcodes = file3;
          postcodes.forEach(function(p){
            postcodeKeys.push(p.id);
          });
        }
        welcome();
      });

    function welcome(){
      /*d3.select('#welcome')
        .style('opacity',0)
        .style('display','block')
        .transition()
          .ease(d3.easeCubicOut)
          .delay(500)
          .duration(500)
          .style('opacity',1)
          .style('padding-top','10px')
          .on('end', function(){
            d3.select('#address').node().focus();
          });*/
        processKitas();
        processFilter();
    }

    function processKitas(){
        geojson = {type:'FeatureCollection',features:[]};
        kitas.forEach(function(d,i){
          kitas[i].all = parseInt(d.all);
          kitas[i].size = Math.pow(parseInt(d.all), 0.2);
          kitas[i].lon = parseFloat(d.alon);
          kitas[i].lat = parseFloat(d.alat);
          kitas[i].oname = kitas[i].name

          var pre = ['AWO Kita', 'AWO ', 'AWO-Kita', 'BOOT-KITA', 'Evangelische Kita ', 'EKG - ', 'EKT - ', 'FRÖBEL Kindergarten ', 'Humanistische Kita ', 'IB-Kita, ', 'Kindergarten ', 'Kita - ', 'Kita ', 'Kindertagesstätte ', 'Kita der Ev. Kirchengem. ', 'Kita der Kath. Kirchengem. ', 'Kinderladen ', 'Kita/', 'Ev. Kita ', 'Ev.Kita ', '- ', '-'];
          pre.forEach(function(p){
            if(kitas[i].name.substr(0, p.length) == p){
              kitas[i].name = kitas[i].name.substr(p.length, kitas[i].name.length);
            }
          });

          kitas[i].name = kitas[i].name.trim();
          kitas[i].name = kitas[i].name.substr(0,1).toUpperCase() + kitas[i].name.substr(1,kitas[i].name.length);

          filter.forEach(function(f){
            if(kitas[i][f]=='' || kitas[i][f] == undefined){
              kitas[i][f] = [];
            }else{
              kitas[i][f] = (kitas[i][f].split('|'));
              kitas[i][f].forEach(function(s, si){ 
                kitas[i][f][si] = parseInt(s); 
              });
            }
          });

          kitas[i].fulltext = kitas[i].address + ' ' + kitas[i].district + ' ' + kitas[i].plz + ' ' + kitas[i].name + ' ' + kitas[i].parent;

          kitas_keys[d.id] = i;
          geojson.features.push({
            type:'Feature',
            properties:{
              data:kitas[i],
              class:'normal',
              size:kitas[i].size
            },
            geometry:{
              type:'Point',
              coordinates:[kitas[i].lon,kitas[i].lat]
            }
          });
        });

        map.addSource('kitas-default', { type: 'geojson', data: geojson });
        map.addSource('kitas-active', { type: 'geojson', data: geojson });

        defaultLayer = map.addLayer({
          "id": "kitas-default",
          "type": "circle",
          "source": "kitas-default",
          "paint": {
            'circle-radius': {
              property: 'size',
              'base': 1.75,
               stops: [
                 [{zoom: 2, value: 0}, 0],
                 [{zoom: 2, value: d3.max(kitas, function(d){return d.size;})}, 3],
                 [{zoom: 22, value: 0}, 0],
                 [{zoom: 22, value: d3.max(kitas, function(d){return d.size;})}, 500]
              ]
            },
            'circle-color': {
              property: 'class',
              type: 'categorical',
              stops: [
                ['normal', 'rgba(230,4,51,1)'],
                ['focussed', 'transparent'],
                ['inactive', '#999999']]
            }
          }
        });

        activeLayer = map.addLayer({
          "id": "kitas-active",
          "type": "circle",
          "source": "kitas-active",
          "paint": {
            'circle-radius': {
              property: 'size',
              'base': 1.75,
               stops: [
                 [{zoom: 2, value: 0}, 0],
                 [{zoom: 2, value: d3.max(kitas, function(d){return d.size;})}, 8],
                 [{zoom: 22, value: 0}, 0],
                 [{zoom: 22, value: d3.max(kitas, function(d){return d.size;})}, 500]
              ]
            },
            'circle-color': {
              property: 'class',
              type: 'categorical',
              stops: [
                ['normal', 'transparent'],
                ['focussed', '#E60433'],
                ['inactive', 'transparent']]
            }
          }
        });

        (['kitas-default','kitas-active']).forEach(function(k){

          map.on('click', k, function (e) {
            var d = JSON.parse(e.features[0].properties.data);
            setDetails(d);
          });

          map.on('mouseenter', k, function () {
              map.getCanvas().style.cursor = 'pointer';
          });

          map.on('mouseleave', k, function () {
              map.getCanvas().style.cursor = '';
          });

        });

        geojson.features = geojson.features.sort(function(a,b){
          if (a.properties.data.name < b.properties.data.name) {
            return -1;
          }
          if (a.properties.data.name > b.properties.data.name) {
            return 1;
          }
          return 0;
        });

        var li = d3.select('#list ul').selectAll('li').data(geojson.features).enter().append('li').style('display',function(d,i){
          if(i>10){
            return 'none';
          }
          return 'block';
        });

        li.append('span').attr('class', 'type')
          .text(function(d){return kitas_dict.type[d.properties.data.type]+' der '+kitas_dict.parent[d.properties.data.parent];});

        li.append('span').attr('class', 'name')
          .text(function(d){return d.properties.data.name;});

        li.append('span').attr('class', 'address')
          .text(function(d){return d.properties.data.address+', '+d.properties.data.plz+' '+d.properties.data.district;});

        d3.select('#detail-close').on('click', function(){
          if(marker){
            marker.remove();
          }

          if(d3.selectAll('#sidemenu li.active').size()==0){
            closeSidebar();
          }else{
            d3.select('#details').style('display','none');
            detailShow = false;
          }
        });

    }

    function setDetails(d){
      detailShow = true;

      if(marker){
        marker.remove();
      }

      marker = new mapboxgl.Marker(el, {
          offset: [5.5, -22.5]
        })
        .setLngLat([d.lon,d.lat])
        .addTo(map);

      d3.select('#details .loading').style('display', 'block');
      d3.select('#detail-content').style('display', 'none');

      d3.select('#details').style('display','block');
      
      openSidebar();

      d3.json('./data/individual/' + d.id + '_kitas.json', function(err, data){
        d3.select('#detail-name').text(d.oname);
        d3.select('#detail-postcode').text(data.postcode.join(','));

        data.link = 'https://www.berlin.de/sen/jugend/familie-und-kinder/kindertagesbetreuung/kitas/verzeichnis/'+data.link;

        data.emailLink = 'mailto:'+data.email;
        (['link','id','num','parent','address','district','type','parentType','mapLink','phone','email','emailLink']).forEach(function(l){
          if(l.indexOf('link')>=0 || l.indexOf('Link')>=0){
            d3.select('#detail-'+l).attr('href', data[l]);
          }else{
            d3.select('#detail-'+l).text(data[l]);
          }
        });

        (['educational','topics','languages']).forEach(function(l){
          while(data[l][0]==""){
            data[l].splice(0,1);
          }
          if(data[l].length == 0){
            d3.selectAll('#detail-' + l + '-head, #detail-' + l).style('display','none');
          }else{
            d3.selectAll('#detail-' + l + '-head, #detail-' + l).style('display','block');
            d3.selectAll('#detail-' + l + ' li').remove();
            d3.select('#detail-' + l).selectAll('li').data(data[l]).enter().append('li')
              .text(function(d){
                return d.trim();
              });
          }
        });

        var noStructure = true;
        d3.select('#detail-structure-head').style('display','block');
        for(var label in data.structure){
          if(data.structure[label] == undefined || data.structure[label] == ''){
            d3.select('#detail-structure-'+label+'-row').style('display','none');
          }else{
            noStructure = false;
            d3.select('#detail-structure-'+label+'-row').style('display','table-row');
            d3.select('#detail-structure-'+label).text(data.structure[label]);
          }
        }

        if(noStructure){
          d3.select('#detail-structure-head').style('display','none');
        }

        var noOpen = true;

        d3.selectAll('.detail-open').style('display','block');
        data.open.forEach(function(o,i){
          if(data.open[i][0] != undefined){
            noOpen = false;
            d3.select('#detail-open-'+i).text(data.open[i][0] + '-' + data.open[i][1]);
          }else{
            d3.select('#detail-open-'+i).text('');
          }
        });

        if(noOpen){
          d3.selectAll('.detail-open').style('display','none');
        }

        d3.select('#details .loading').style('display', 'none');
        d3.select('#detail-content').style('display', 'block');
      });
    }

    function openSidebar(){
      if(!d3.select('#sidebar').classed('active')){
        d3.select('#sidebar')
          .classed('active',true);

        if(window.innerWidth > 768){
          map.panTo(map.getCenter(), {duration:500, offset:{x:200,y:0}});
        }
      }
    }

    function closeSidebar(){
      if(d3.select('#sidebar').classed('active')){
        d3.select('#sidebar')
          .classed('active',false);

        if(window.innerWidth > 768){
          map.panTo(map.getCenter(), {duration:500, offset:{x:-200,y:0}});
        }
      }
    }

    function updateKitas(){
      var filtersFound = false;
      for(var s in selection){
        if(selection[s].length > 0){
          filtersFound = true;
          filterElements[s].box.classed('filter-set', true);
        }else{
          filterElements[s].box.classed('filter-set', false);
        }
      }

      if(filtersFound){
        d3.select('#reset').style('display','block');
      }else{
        d3.select('#reset').style('display','none');
      }

      var found = 0;

      geojson.features.forEach(function(d,i){
        var show = true;

        for(var s in selection){
          selection[s].forEach(function(f){
            if(geojson.features[i].properties.data[s].indexOf(f)==-1){
              show = false;
            }
          });
        }


        
        if(show){
          if(filtersFound){
            found++;
            geojson.features[i].properties.class = 'focussed';
          }else{
            found++;
            geojson.features[i].properties.class = 'normal';
          }
        }else{
          geojson.features[i].properties.class = 'inactive';
        }
      });

      map.setPaintProperty('kitas-active', 'circle-radius', (found<10)?10/found+5:5);

      geojson.features.sort(function(a,b){
        var ac = a.properties.class,
          bc = b.properties.class;

        if(ac == bc){
          return 0;
        }else if(ac == 'focussed'){
          return 1;
        }else if(bc == 'focussed'){
          return -1;
        }        
        
        return 0;  
      });

      map.getSource('kitas-active').setData(geojson);
      map.getSource('kitas-default').setData(geojson);

      //Reset filters
      filter.forEach(function(f){
        filters[f].forEach(function(ff,fi){
          filters[f][fi].count = 0;
        });
      });

      //Update filters based on reset kitas
      geojson.features.forEach(function(k){
        if(k.properties.class == 'normal' || k.properties.class == 'focussed'){
          filter.forEach(function(f){
            k.properties.data[f].forEach(function(ff){
              if(filterKeys[f][ff] in filters[f]){
                filters[f][filterKeys[f][ff]].count++;
              }
            });
          });
        }
      });

      //Update Display
      filter.forEach(function(f){
        filterElements[f].groups.data(filters[f]).style('opacity', function(d){
          if(d.count > 0){
            return 1;
          }else{
            return 0.2;
          }
        });

        filterElements[f].counts.transition()
          .tween("text", function(d) {
            var that = d3.select(this),
                i = d3.interpolateNumber(parseInt(that.text()), d.count);
            return function(t) { that.text(Math.round(i(t))); };
          });

        filterElements[f].bars.transition()
          .attr('x2', function(d,i){ return scales[f](d.count); });
      });

      d3.select('#list ul').selectAll('li').data(geojson.features)
        .style('display', function(d,i){ 
          if(!filtersFound && i>10){
            return 'none';
          }else if(!filtersFound){
            return 'block';
          }
          return (d.properties.class == 'normal' || d.properties.class == 'focussed')?'block':'none';
        });
    }

    function processFilter(){
      d3.select('#reset').on('click', function(){
        for(var s in selection){
          selection[s] = [];
        }
        d3.selectAll('.filter-list-container li').classed('active',false);
        updateKitas();
      });

      var overlay = d3.select('#filter-container');
          
      filter.forEach(function(f){
        filters[f] = [];
        selection[f] = [];
        filterKeys[f] = {};
        filterElements[f] = {titles:null, groups:null, counts:null, bars:null, box:null};
        kitas_dict[f].forEach(function(ff, ffi){
          filters[f].push({count:0, all:0, id:ffi, name:ff, type:f});
        });
      });

      kitas.forEach(function(k){
        filter.forEach(function(f){
          k[f].forEach(function(ff){
            filters[f][ff].count++;
            filters[f][ff].all++;
          });
        });
      });

      var lineHeight = 28, borderRadius = 2.5, width = 287;

      filter.forEach(function(f){
        filters[f] = filters[f].filter(function(d){
          if(d.name != '' && d.name != '(n.v.)'){
            return true;
          }
          return false;
        });

        var height = lineHeight*filters[f].length;

        var box = overlay.append('div').attr('class','filter-container');
        filterElements[f].box = box;

        var title = box.append('span')
          .attr('class', 'filter-title')
          .on('click', function(){
            var current = d3.select(this.parentNode).select('.filter-list-container');
            if(current.style('display')=='block'){
              d3.selectAll('.filter-title').classed('active',false);
              d3.selectAll('.filter-list-container').style('display','none');
            }else{
              d3.selectAll('.filter-title').classed('active',false);
              d3.selectAll('.filter-list-container').style('display','none');
              d3.select(this).classed('active',true);
              current.style('display','block');
            }
          });

        filterElements[f].titles = title;

        title.append('img').attr('src', 'images/icon-'+f+'@2x.png');
        title.append('span').html(labels[f]+'<img src="images/icon-checkmark-top@2x.png" />');

        var list = box.append('ul')
          .attr('class','filter-list-container')
          .style('display', 'none');

        scales[f] = d3.scaleLinear().domain([0,d3.max(filters[f], function(d){return d.count;})]).range([borderRadius,width-2*borderRadius]);

        filters[f].sort(function(a,b){
          return b.count-a.count;
        });

        filters[f].forEach(function(ff, fi){
          filterKeys[f][ff.id] = fi;
        });


        var groups = list.selectAll('li').data(filters[f]).enter().append('li').on('click', function(d){
          if(d3.select(this).classed('active')){
            d3.select(this).classed('active',false);
            removeSelection(d);
          }else{
            d3.select(this).classed('active',true);
            addSelection(d);
          }
        });

        filterElements[f].groups = groups;

        var label = groups.append('span')
          .attr('class', 'label');

        label.append('span').text(function(d){ return cleanFilterLabel(d.name) + ' ('; });
        filterElements[f].counts = label.append('span').text(function(d){ return d.count; });
        label.append('span').text(')');

        var svg = groups.append('svg')
          .attr('width', width)
          .attr('height', borderRadius*2 + 2);

        svg.append('line')
          .attr('class','bar bg')
          .attr('x1',borderRadius)
          .attr('y1', borderRadius + 1)
          .attr('x2',width - 2*borderRadius)
          .attr('y2', borderRadius + 1);

        filterElements[f].bars = svg.append('line')
          .attr('class','bar data')
          .attr('x1', borderRadius)
          .attr('y1', borderRadius + 1)
          .attr('x2', function(d,i){ return scales[f](d.count); })
          .attr('y2', borderRadius + 1);
        
      });

      initDone();
    }

    function initDone(){
      d3.select('#loading')
        .transition()
          .ease(d3.easeCubicIn)
          .duration(500)
          .style('display','none');

      d3.select('#sidebar')
        .transition()
          .delay(500)
          .ease(d3.easeCubicOut)
          .duration(500)
          .style('display','block')
          .style('opacity',1);

      d3.selectAll('#sidemenu li').datum(function(){
        return d3.select(this).attr('data-item');
      }).on('click', function(d){
        if(d3.select(this).classed('active')&&!detailShow){
          d3.selectAll('#sidemenu li').classed('active',false);
          closeSidebar();
        }else{
          detailShow = false;
          if(marker){
            marker.remove();
          }

          d3.selectAll('#sidemenu li').classed('active',false);
          d3.select(this).classed('active',true);
          
          d3.selectAll('.sidebar-content').style('display','none');
          d3.select('#'+d).style('display','block');
          openSidebar();
        }
      });
    }

    function addSelection(d){
      if(selection[d.type].indexOf(d.id)==-1){
        selection[d.type].push(d.id);
        updateKitas();
      }
    }

    function removeSelection(d){
      if(selection[d.type].indexOf(d.id)>=0){
        selection[d.type].splice(selection[d.type].indexOf(d.id), 1);
      }
      updateKitas();
    }

    function cleanFilterLabel(t){
      if(t.indexOf('deutsch - ') == 0){
        return t.substr(10,1).toUpperCase() + t.substr(11);
      }
      if(t.indexOf('Musik und Kunst') > -1){
        return t.replace('Musik und Kunst','Musik & Kunst');
      }
      if(t.substr(0,1)=='(' && t.substr(t.length-1,1)==')'){
        if(t.indexOf('Rahmenvereinbarung')>=0){
          return 'Private Kita ohne Rahmenvereinbarung';
        }
        if(t.indexOf('EKT')>=0){
          return 'Eltern-Initiativ-Kindertagesstätte';
        }
        return t.substr(1,t.length-2);
      }
      
      return t;
    }

    d3.select('#postcode-input').on('keyup', function(){
      var v = this.value.trim();
      if(v.length == 5){

        var idx = postcodeKeys.indexOf(v);
        if(idx>=0){
          map.fitBounds([postcodes[idx].xmin,postcodes[idx].ymin,postcodes[idx].xmax,postcodes[idx].ymax]);
          postcodeError('Nutzen Sie auch die Filter um die Auswahl einzuschränken.',false);
        }else{
          postcodeError('Dies ist keine Berliner Postleitzahlen.',true);
        }

      }else if(v.length > 5){
        postcodeError('Postleitzahlen bestehen aus 5 Ziffern.',true);
      }else{
        postcodeError('',false);
      }
    });

    function postcodeError(e,et){
      d3.select('#postcode-error').text(e);
      d3.select('#postcode-error').classed('error',et);
    }

    var active_selection = 0;

    d3.select('#address').on('keyup', function(){
      var suggest_length = d3.selectAll('#autosuggest ul li').size();
      if(suggest_length >= 1 && (d3.event.keyCode == 40 || d3.event.keyCode == 38 || d3.event.keyCode == 13)){
        if(d3.event.keyCode == 40){
          if(active_selection<suggest_length){
            active_selection++;
          }
        }else if(d3.event.keyCode == 38){
          if(active_selection>=1){
            active_selection--;
          }
        }
        d3.selectAll('#autosuggest ul li').classed('active',false);
        if(active_selection>0){
          d3.select('#autosuggest ul li:nth-child('+active_selection+')').classed('active',true);
        }
        if(d3.event.keyCode == 13){
          selectStreet(d3.select('#autosuggest ul li:nth-child('+active_selection+')').datum());
        }
      }else{
        if(this.value.length > 2){
          d3.selectAll('#number option').remove();
          d3.json('http://localhost:1818/street?street='+this.value, function(err, data){
            active_selection = 0;
            d3.selectAll('#autosuggest ul li').remove();
            d3.select('#autosuggest').style('display','block');
            d3.select('#autosuggest ul').selectAll('li')
              .data(data).enter().append('li').append('a')
                .html(function(d){ return '&raquo;&nbsp;'+d.street+((parseInt(d.plz)>0)?' '+d.plz:''); })
                .on('click', function(){
                  selectStreet(d3.select(this).datum());
                });
          });
        }
      }
    });

    function selectStreet(d){
      var el = document.getElementById('address');
      el.blur();
      el.value = d.street;
      d3.select('#address').attr('data-id', d.id);
      d3.selectAll('#autosuggest ul li').remove();
      d3.select('#autosuggest').style('display','none');
      d3.json('http://localhost:1818/num?street='+d.id, function(err, data){
        data.forEach(function(d,i){
          var num_a = d.num.split(''), num = '', letter = '';
          num_a.forEach(function(n){
            if(!isNaN(n)){
              num += n;
            }else{
              letter += n;
            }
          });
          d.int = +num;
          d.letter = letter;
        });
        data.sort(function(a,b){
          if(a.int === b.int){
            if (a.letter < b.letter) {
              return -1;
            }
            if (a.letter > b.letter) {
              return 1;
            }
            return 0;
          }else{
            return a.int - b.int;
          }
        });
        d3.selectAll('#number option').remove();
        d3.select('#number').selectAll('option').data(data)
          .enter().append('option')
            .attr('value', function(d){return d.id;})
            .text(function(d){ return d.num; });
      });
    }

    d3.select('#submit').on('click', function(){
      //Check if road and number are present
      var s_id = d3.select('#address').attr('data-id');
      var select = document.getElementById( "number" );
      var n_id = false;
      if(select.selectedIndex > -1){
        n_id = select.options[ select.selectedIndex ].value;
      }
      
      if(s_id != null && n_id){

        d3.select('#welcome')
          .transition()
            .ease(d3.easeCubicIn)
            .duration(500)
            .style('opacity',0)
            .style('padding-top','0px')
            .on('end', function(){
              d3.select('#loading')
                .transition()
                  .ease(d3.easeCubicOut)
                  .duration(500)
                  .style('opacity',1);

              d3.json('http://localhost:1818/geo?num='+n_id, function(err, json){
                console.log(json.lat, json.lon);
              });
            });
      }else{
        alert('Bitte Straße und Hausnummer auswählen.')
      }
    });
  </script>
</body>
</html>
